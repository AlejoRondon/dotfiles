#!/bin/bash

set -eu -o pipefail

DIR="${1-$(pwd)}"

function pull {
  if [ -d .git ]; then
    if git config remote.origin.url > /dev/null; then
      BRANCH="$(git symbolic-ref --short HEAD)"
      echo "$(tput bold)Pulling $d on branch $(tput setaf 4)$BRANCH$(tput sgr0)"
      set +e
      git pull --rebase=preserve
      set -e
    fi
  fi
}

# Require to handle a potential empty $DIR
shopt -s nullglob

(
  cd "$DIR"
  for d in */ ; do
  (
    cd "$d"
    pull "$d"
  )
  done
)

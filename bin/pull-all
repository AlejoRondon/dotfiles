#!/bin/bash

set -euo pipefail

BASE_DIR="${1-$(pwd)}"
BRANCH="${2-master}"

# Required to handle a potential empty $BASE_DIR
shopt -s nullglob

function pull {
  CURRENT_DIR=$1
  TARGET_BRANCH=$2
  if [ -d .git ]; then
    if git config remote.origin.url > /dev/null; then
      CURRENT_BRANCH="$(git symbolic-ref -q --short HEAD || echo 'detached')"

      if [ "$CURRENT_BRANCH" == "detached" ]; then
        echo "$(tput bold)$(tput setaf 3)Skipping $CURRENT_DIR: detached HEAD$(tput sgr0)"
      elif ! git branch | grep -q "$TARGET_BRANCH"; then
        echo "$(tput bold)$(tput setaf 3)Skipping $CURRENT_DIR: branch $TARGET_BRANCH missing$(tput sgr0)"
      else
        if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
          git checkout "$TARGET_BRANCH"
        fi

        echo "$(tput bold)Pulling $CURRENT_DIR on branch $(tput setaf 4)$TARGET_BRANCH$(tput sgr0)"
        set +e
        git pull
        set -e
      fi
    fi
  fi
}

(
  cd "$BASE_DIR"
  for d in */ ; do
  (
    cd "$d"
    pull "${d%/}" "$BRANCH"
  )
  done
)

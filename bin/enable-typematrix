#!/bin/bash

#
# Enable other standard keyboards along a connected TypeMatrix.
#
# Beware: the TypeMatrix needs to be re-activated after the
# standard keyboard have been activated (else it will be overridden)

set -euo pipefail

readonly TYPEMATRIX_KEYBOARD_LABEL="TypeMatrix.com USB Keyboard"

function findKeyboardIds {
  local keyboardLabel="$1"

  xinput list | \
        grep keyboard | \
        grep "$keyboardLabel" | \
        sed 's/.*id=\([0-9]*\).*/\1/'
}

function enableTypeMatrix {
  readonly keyboardIds=$(findKeyboardIds "$TYPEMATRIX_KEYBOARD_LABEL")

  for keyboard in $keyboardIds; do
    setxkbmap -device "$keyboard" us -variant colemak
  done

  if [ -n "$keyboardIds" ]; then
      echo "$(date) Found keyboards $keyboardIds"
      notify-send -i "input-keyboard" "Success" "TypeMatrix keyboard enabled"
  else
      echo "$(date) Not found keyboards $keyboardIds"
      notify-send -i "error" "Error" "TypeMatrix keyboard not activated"
  fi
}

enableTypeMatrix

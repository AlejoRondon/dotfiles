#compdef rake
if [ -f Rakefile ]; then
  # Select the correct rake
  env_cmd="/usr/bin/env"
  if [ -e ./Gemfile.lock ]; then
    env_cmd="bundle exec"
  fi

  # Generate cached tasks list only if needed
  recent=`last_modified .rake_tasks~ Rakefile **/*.rake`
  if [[ $recent != '.rake_tasks~' ]]; then
    ${=env_cmd} rake --silent --tasks | cut -d " " -f 2 > .rake_tasks~ 2> .error
  fi

  compadd `cat .rake_tasks~`
fi
